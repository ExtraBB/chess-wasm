@page "/"
@inject IJSRuntime JsRuntime;
@using ChessWasm.Models;
@using ChessWasm.Services;
@using ChessWasm.Shared;

<h1>Hello, world!</h1>

<div>
    <button @onclick="StartGame">New Game</button>
    <button @onclick="RandomMove">Random Move</button>
</div>

<ChessBoard @ref="chessBoard" @bind-Squares="squares" /> 

@code {
    private GameService gameService = new GameService();
    private Piece[] squares = null;
    ChessBoard chessBoard;

    Random rand = new Random();

    private void StartGame()
    {
        gameService.StartGame();
        gameService.CurrentGame.Board.BoardChanged += BoardChanged;
        squares = gameService.CurrentGame.Board.Squares;
    }

    private void RandomMove()
    {
        int from = 0, to = 0;
        while(from == to || squares[from] == 0)
        {
            from = rand.Next(0, 64);
            to = rand.Next(0, 64);
        }
        Console.WriteLine($"Moving {from} to {to}");
        gameService.CurrentGame.MakeMove(from, to);
    }

    private void BoardChanged(object sender, BoardChangedEventArgs args) 
    {
        chessBoard.SquaresChanged.InvokeAsync((sender as Board).Squares);
    }
}
